#!/bin/bash

# This is practically a workflow.yml document. It just has a section for expanding its arguments
# into a YAML array.

cat <<'EOT'
#
# This workflow was created automatically from the `auto-update-template.yml` by running `make -C .github workflows`
# DO NOT EDIT THIS WORKFLOW
#

name: "auto-update-packages"
on:
  schedule:
    # Update packages nightly
    - cron:  '0 0 * * *'

jobs:
  auto-update:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package-name:
EOT

for pkg in "$@"; do
  if [[ $(make -sC ../vendor/$pkg info/auto-update-enabled) != "false" ]]; then
    printf "        - %s\n" $pkg
  else
    echo Auto-update of $pkg is disabled >&2
  fi
done

cat <<'EOF'

    steps:
      - uses: actions/checkout@v2

      - name: Get current package information
        shell: bash
        id: current
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        run: |
          make -C vendor/${{matrix.package-name}} info/github

      - name: Update packages
        shell: bash
        id: update
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        run: |
          make -C vendor/${{matrix.package-name}} auto-update
          make -C vendor/${{matrix.package-name}} info/github

      - name: Update readme
        shell: bash
        id: readme
        if: steps.update.outputs.package_version != steps.current.outputs.package_version
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        run: |
          make init
          make readme/deps
          make readme

      - name: Create Pull Request
        uses: cloudposse/actions/github/create-pull-request@0.20.0
        if: steps.update.outputs.package_version != steps.current.outputs.package_version
        with:
          token: ${{ secrets.GITHUB_BOT_TOKEN }}
          commit-message: Update ${{ steps.update.outputs.package_name }} to ${{ steps.current.outputs.package_version }} â†’ ${{ steps.update.outputs.package_version }}
          title: Update ${{ steps.update.outputs.package_name }} to ${{ steps.update.outputs.package_version }}
          body: |-
            ## what

            This is an auto-generated PR that updates the ${{ steps.update.outputs.package_name }} package version.

            | Meta              | Details                                      |
            |:------------------|:---------------------------------------------|
            | **Package Name**  | `${{ steps.update.outputs.package_name }}`   |
            | **Vendor**        | [${{ steps.update.outputs.vendor }}](${{ steps.update.outputs.package_homepage_url }}) |
            | **Version**       | ${{ steps.update.outputs.package_version }}  |
            | **License**       | ${{ steps.update.outputs.package_license }}  |
            | **Repo**          | ${{ steps.update.outputs.package_repo_url }} |
            | **Arch**          | ${{ steps.update.outputs.arch }}             |
            | **OS**            | ${{ steps.update.outputs.os }}               |
            | **Download URL**  | ${{ steps.update.outputs.download_url }}     |

            ## why

            Publish the latest release of `${{ steps.update.outputs.package_name }}` to our package repository.

          branch: auto-update/${{ steps.update.outputs.package_name }}-${{ steps.update.outputs.package_version }}
          base: master
          delete-branch: true
          labels: |
            auto-update
            vendor/${{ steps.update.outputs.package_name }}
EOF
